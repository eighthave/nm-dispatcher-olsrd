#!/usr/bin/python
#

# TODO
# read in profiles and add them to NetworkManager
# setup static net config?
# start/stop olsrd
# config wireless
# disable everything when receiving 'wlan0 off'
# any use for the env vars sent with 'up'?

import glob
import pyjavaproperties
import sys
import NetworkManager

class MeshConnection():

    olsrd = None

    def __init__(self, interface, status):
        self.f = open('/tmp/nm-dispatcher-olsrd.log', 'ab')

        meshconnection = self.getMeshConnection(interface)
        if meshconnection:
            if status == 'up':
                self.startOlsrd()
            elif status == 'down':
                self.stopOlsrd()
        else:
            self.log('"' + interface + '" is not a mesh connection, ignoring.')


    def log(self, msg):
        self.f.write(msg + '\n')

    def readProfiles(self):
        '''get all the available mesh profiles and return as a dict'''
        profiles = dict()
        for f in glob.glob('/home/hans/code/eighthave/nm-dispatcher-olsrd/profiles/*.profile'):
            p = pyjavaproperties.Properties()
            p.load(open(f))
            profile = dict()
            for k,v in p.items():
                profile[k] = v
            channeltag = '%02x' % int(p['channel'])
            profiles[p['ssid'] + channeltag] = profile
        return profiles


    def readConnections(self):
        '''
        Get all pre-configured wifi connections from NetworkManager and return dict'''
        connections = dict()
        for c in NetworkManager.Settings.ListConnections():
            settings = c.GetSettings()
            if settings['connection']['type'] == '802-11-wireless':
                k = settings['connection']['id']
                connections[k] = settings
        return connections


    def getMeshConnection(self, interface):
        '''
        read the data about the active connections for a given interface
        '''
        connection = None

        # first find the active connection that we are interested in
        foundit = False
        for ac in NetworkManager.NetworkManager.ActiveConnections:
            for d in ac.Devices:
                wireless = None
                ap = None
                if d.Managed and d.Interface == interface \
                        and d.DeviceType == NetworkManager.NM_DEVICE_TYPE_WIFI:
                    wireless = d.SpecificDevice()
                    if wireless.Mode == NetworkManager.NM_802_11_MODE_ADHOC:
                        ap = wireless.ActiveAccessPoint
                        foundit = True
                        break
            if foundit:
                break
            ac = None
        if ac == None:
            return None

        # then find the settings for that active connection
        settings = ac.Connection.GetSettings()
        if settings and ap \
                and settings['connection']['type'] == '802-11-wireless' \
                and ap.Ssid == settings['802-11-wireless']['ssid']:
            w = dict()
            w['mac-address'] = wireless.HwAddress
            w['bitrate'] = wireless.Bitrate
            w['ssid'] = ap.Ssid
            w['bssid'] = ap.HwAddress
            w['channel'] = (ap.Frequency - 2407) / 5
            w['maxbitrate'] = ap.MaxBitrate
            w['strength'] = ap.Strength
            self.log('Found mesh adhoc connection: ' + w['ssid'] + '/'
                     + w['bssid'] + '/' + str(w['channel']))
            connection = settings
            connection['wireless'] = w

        return connection


    def startOlsrd(self):
        '''start the olsrd daemon'''
        self.log('start oslrd')


    def stopOlsrd(self):
        '''stop the olsrd daemon'''
        self.log('stop oslrd')


interface = sys.argv[1]
status = sys.argv[2]
m = MeshConnection(interface, status)
